<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BORROW LEDGER â€” Asset Tracking System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getDatabase, ref, push, set, get, update, remove, onValue }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  // ============================================================
  //  âš™ï¸  PASTE YOUR FIREBASE CONFIG HERE
  // ============================================================
  const firebaseConfig = {
    apiKey: "AIzaSyCq6gqjNwKijOLZyhkVt7JkfeJ3Rt8oUUI",
    authDomain: "borrow--ledger.firebaseapp.com",
    databaseURL: "https://borrow--ledger-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "borrow--ledger",
    storageBucket: "borrow--ledger.firebasestorage.app",
    messagingSenderId: "184622919000",
    appId: "1:184622919000:web:248e0a690c6e81c932892d"
  };

  // ============================================================
  //  âš™ï¸  TELEGRAM BOT TOKEN  (from @BotFather)
  // ============================================================
  const TELEGRAM_BOT_TOKEN = "8653074911:AAElOVLibDBYW9GX4Y1lxtA592fIFqZzABc";

  // â”€â”€â”€ Init â”€â”€â”€
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getDatabase(app);

  // â”€â”€â”€ Device Fingerprint â”€â”€â”€
  function getDeviceFingerprint() {
    const raw = [navigator.userAgent, navigator.language, navigator.platform,
      screen.width, screen.height, screen.colorDepth, new Date().getTimezoneOffset()].join("||");
    let h = 0;
    for (let i = 0; i < raw.length; i++) { h = ((h << 5) - h) + raw.charCodeAt(i); h |= 0; }
    return Math.abs(h).toString(16).padStart(8, "0");
  }
  const DEVICE_ID = getDeviceFingerprint();

  async function isDeviceAuthorized() {
    try {
      const snap = await get(ref(db, `authorized_devices/${DEVICE_ID}`));
      return snap.exists() && snap.val().active === true;
    } catch { return false; }
  }

  // â”€â”€â”€ Expose to global â”€â”€â”€
  window._auth = auth; window._db = db;
  window._ref = ref; window._push = push; window._set = set;
  window._get = get; window._update = update; window._remove = remove;
  window._onValue = onValue; window._deviceId = DEVICE_ID;
  window._isDeviceAuthorized = isDeviceAuthorized;
  window._signInFn = signInWithEmailAndPassword;
  window._signOutFn = signOut; window._onAuthChanged = onAuthStateChanged;
  window._TELEGRAM_BOT_TOKEN = TELEGRAM_BOT_TOKEN;

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const ok = await isDeviceAuthorized();
      if (!ok) { await signOut(auth); window._showDeviceError(); return; }
      window._onLogin(user);
    } else { window._onLogout(); }
  });
</script>

<style>
:root {
  --bg:#0a0a0f; --surface:#111118; --panel:#16161f; --border:#2a2a38; --border2:#3a3a50;
  --text:#e8e8f0; --muted:#7070a0; --accent:#f0c040; --accent2:#40d0a0; --danger:#f05060;
  --cash:#40c870; --item:#6090ff; --font-head:'Syne',sans-serif; --font-mono:'Space Mono',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:var(--font-mono);font-size:13px;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:999;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");opacity:.4;}
::-webkit-scrollbar{width:6px;height:6px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
#app{display:flex;flex-direction:column;min-height:100vh;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:100;}
.logo{font-family:var(--font-head);font-size:18px;font-weight:800;letter-spacing:.08em;color:var(--accent);}
.logo span{color:var(--muted);font-weight:400;font-size:11px;display:block;letter-spacing:.15em;}
.topbar-right{display:flex;align-items:center;gap:16px;}
.device-badge{font-size:10px;color:var(--muted);letter-spacing:.1em;border:1px solid var(--border);padding:3px 8px;}
.user-badge{font-size:11px;color:var(--accent2);display:flex;align-items:center;gap:8px;}
.btn-logout{background:none;border:1px solid var(--border);color:var(--muted);padding:5px 12px;cursor:pointer;font-family:var(--font-mono);font-size:11px;letter-spacing:.08em;transition:all .2s;}
.btn-logout:hover{border-color:var(--danger);color:var(--danger);}
main{display:flex;flex:1;overflow:hidden;}
.sidebar{width:220px;min-width:220px;border-right:1px solid var(--border);background:var(--surface);padding:24px 0;}
.nav-item{padding:11px 24px;cursor:pointer;font-size:11px;letter-spacing:.1em;color:var(--muted);transition:all .15s;border-left:2px solid transparent;display:flex;align-items:center;gap:10px;text-transform:uppercase;}
.nav-item:hover{color:var(--text);background:rgba(255,255,255,.03);}
.nav-item.active{color:var(--accent);border-left-color:var(--accent);background:rgba(240,192,64,.05);}
.nav-section{padding:20px 24px 8px;font-size:9px;color:var(--border2);letter-spacing:.2em;text-transform:uppercase;}
.content{flex:1;overflow-y:auto;padding:32px;}
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;}
.page-title{font-family:var(--font-head);font-size:28px;font-weight:800;line-height:1;}
.page-title span{color:var(--accent);}
.page-sub{font-size:11px;color:var(--muted);margin-top:4px;letter-spacing:.08em;}
.stats-strip{display:flex;gap:16px;margin-bottom:28px;flex-wrap:wrap;}
.stat-card{flex:1;min-width:140px;background:var(--panel);border:1px solid var(--border);padding:16px 20px;position:relative;overflow:hidden;}
.stat-card::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat-card.s1::after{background:var(--accent);}.stat-card.s2::after{background:var(--accent2);}
.stat-card.s3::after{background:var(--cash);}.stat-card.s4::after{background:var(--item);}
.stat-label{font-size:9px;color:var(--muted);letter-spacing:.18em;text-transform:uppercase;}
.stat-value{font-family:var(--font-head);font-size:30px;font-weight:800;margin-top:4px;line-height:1;}
.btn{display:inline-flex;align-items:center;gap:8px;padding:9px 18px;border:none;cursor:pointer;font-family:var(--font-mono);font-size:11px;letter-spacing:.1em;text-transform:uppercase;transition:all .2s;font-weight:700;}
.btn-primary{background:var(--accent);color:#000;}.btn-primary:hover{background:#ffd060;}
.btn-secondary{background:var(--panel);border:1px solid var(--border2);color:var(--text);}.btn-secondary:hover{border-color:var(--accent);color:var(--accent);}
.btn-danger{background:none;border:1px solid var(--danger);color:var(--danger);padding:6px 12px;font-size:10px;}.btn-danger:hover{background:var(--danger);color:#fff;}
.btn-tg{background:#2a7ab5;color:#fff;}.btn-tg:hover{background:#3a8ac5;}
.btn-sm{padding:5px 10px;font-size:10px;}
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:1px solid var(--accent);}
thead th{padding:10px 14px;text-align:left;font-size:9px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);font-weight:700;}
tbody tr{border-bottom:1px solid var(--border);transition:background .12s;cursor:pointer;}
tbody tr:hover{background:rgba(255,255,255,.025);}
tbody td{padding:12px 14px;font-size:12px;vertical-align:middle;}
.td-mono{font-family:var(--font-mono);font-size:11px;}
.badge{display:inline-block;padding:2px 8px;font-size:9px;letter-spacing:.1em;text-transform:uppercase;font-weight:700;border-radius:1px;}
.badge-cash{background:rgba(64,200,112,.15);color:var(--cash);border:1px solid rgba(64,200,112,.3);}
.badge-item{background:rgba(96,144,255,.15);color:var(--item);border:1px solid rgba(96,144,255,.3);}
.badge-pending{background:rgba(240,192,64,.12);color:var(--accent);border:1px solid rgba(240,192,64,.25);}
.badge-returned{background:rgba(64,208,160,.12);color:var(--accent2);border:1px solid rgba(64,208,160,.25);}
.badge-out{background:rgba(240,80,96,.12);color:var(--danger);border:1px solid rgba(240,80,96,.25);}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px);opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--panel);border:1px solid var(--border2);width:100%;max-width:640px;max-height:90vh;overflow-y:auto;transform:translateY(20px);transition:transform .25s;}
.modal-overlay.open .modal{transform:translateY(0);}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.modal-title{font-family:var(--font-head);font-size:18px;font-weight:800;}
.modal-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:20px;line-height:1;padding:4px;}.modal-close:hover{color:var(--danger);}
.modal-body{padding:24px;}.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.form-group{display:flex;flex-direction:column;gap:6px;}.form-group.full{grid-column:1/-1;}
label{font-size:10px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;}
input,select,textarea{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px 12px;font-family:var(--font-mono);font-size:12px;outline:none;transition:border .15s;width:100%;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
textarea{min-height:80px;resize:vertical;}select option{background:var(--panel);}
.checkbox-list{display:flex;flex-direction:column;gap:8px;max-height:180px;overflow-y:auto;}
.checkbox-item{display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px;}
.checkbox-item input[type=checkbox]{width:auto;accent-color:var(--accent);}
.checkbox-item label{font-size:12px;color:var(--text);cursor:pointer;text-transform:none;letter-spacing:0;}
#login-screen{position:fixed;inset:0;background:var(--bg);z-index:300;display:flex;align-items:center;justify-content:center;}
.login-box{width:100%;max-width:380px;padding:48px 40px;border:1px solid var(--border2);background:var(--panel);position:relative;}
.login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--accent);}
.login-logo{font-family:var(--font-head);font-size:22px;font-weight:800;color:var(--accent);margin-bottom:4px;}
.login-sub{font-size:11px;color:var(--muted);letter-spacing:.12em;margin-bottom:32px;}
.login-error{color:var(--danger);font-size:11px;margin-top:8px;min-height:16px;}
#toast-container{position:fixed;bottom:24px;right:24px;z-index:500;display:flex;flex-direction:column;gap:10px;}
.toast{padding:12px 18px;background:var(--panel);border-left:3px solid var(--accent2);font-size:12px;max-width:320px;box-shadow:0 8px 24px rgba(0,0,0,.5);animation:slideIn .3s ease;display:flex;align-items:center;gap:10px;}
.toast.error{border-left-color:var(--danger);}.toast.warn{border-left-color:var(--accent);}
@keyframes slideIn{from{transform:translateX(40px);opacity:0;}to{transform:translateX(0);opacity:1;}}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}
.toolbar{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;}
.search-input{flex:1;min-width:200px;}
.empty-state{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-state .es-icon{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:12px;letter-spacing:.08em;}
.tg-preview{background:var(--bg);border:1px solid var(--border);padding:12px;font-size:11px;color:var(--muted);min-height:80px;white-space:pre-wrap;margin-top:8px;line-height:1.6;}
.tg-recipients{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.detail-row td{padding:0!important;background:rgba(240,192,64,.03);}
.detail-inner{padding:16px 28px;border-bottom:1px solid var(--border);display:flex;gap:40px;flex-wrap:wrap;}
.detail-field{display:flex;flex-direction:column;gap:3px;}
.detail-field-label{font-size:9px;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;}
.detail-field-value{font-size:13px;}
.settings-section{background:var(--panel);border:1px solid var(--border);margin-bottom:20px;}
.settings-section-header{padding:14px 20px;border-bottom:1px solid var(--border);font-family:var(--font-head);font-weight:700;font-size:14px;}
.settings-body{padding:20px;}
.settings-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.settings-row:last-child{border-bottom:none;}
.settings-row-label{font-size:12px;}.settings-row-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.fade-in{animation:fadeIn .3s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:translateY(0);}}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--accent2);display:inline-block;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
@media(max-width:768px){.sidebar{display:none;}.form-grid{grid-template-columns:1fr;}.tg-recipients{grid-template-columns:1fr;}.content{padding:16px;}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">â—ˆ BORROW LEDGER</div>
    <div class="login-sub">AUTHORIZED ACCESS ONLY</div>
    <div class="form-group" style="margin-bottom:14px">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="user@domain.com" autocomplete="username">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    </div>
    <div id="login-error" class="login-error"></div>
    <button class="btn btn-primary" style="width:100%;margin-top:20px;justify-content:center" onclick="doLogin()">
      <span id="login-btn-text">ACCESS SYSTEM</span>
    </button>
    <div style="margin-top:16px;font-size:10px;color:var(--muted);text-align:center">
      DEVICE ID: <span id="device-id-display" style="color:var(--accent)">loadingâ€¦</span>
    </div>
  </div>
</div>

<!-- DEVICE ERROR -->
<div id="device-error" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:400;align-items:center;justify-content:center">
  <div style="text-align:center;padding:40px">
    <div style="font-size:48px;margin-bottom:16px">â›”</div>
    <div style="font-family:var(--font-head);font-size:20px;color:var(--danger);font-weight:800">UNAUTHORIZED DEVICE</div>
    <div style="color:var(--muted);margin-top:8px;font-size:12px">Not registered. Share this Device ID with your admin:</div>
    <div id="blocked-device-id" style="color:var(--accent);font-family:var(--font-mono);font-size:16px;margin-top:12px;padding:10px 20px;border:1px solid var(--border);display:inline-block"></div>
    <br><button class="btn btn-secondary" style="margin-top:20px" onclick="location.reload()">RETRY</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none">
  <header class="topbar">
    <div class="logo">â—ˆ BORROW LEDGER <span>REALTIME DATABASE</span></div>
    <div class="topbar-right">
      <span class="live-dot" title="Live sync active"></span>
      <div class="device-badge">DEV: <span id="topbar-device-id"></span></div>
      <div class="user-badge">â— <span id="topbar-user"></span></div>
      <button class="btn-logout" onclick="doLogout()">SIGN OUT</button>
    </div>
  </header>
  <main>
    <nav class="sidebar">
      <div class="nav-section">Menu</div>
      <div class="nav-item active" onclick="showPage('ledger')" id="nav-ledger"><span>ğŸ“‹</span> Ledger</div>
      <div class="nav-item" onclick="showPage('new')" id="nav-new"><span>ï¼‹</span> New Entry</div>
      <div class="nav-section">Config</div>
      <div class="nav-item" onclick="showPage('contacts')" id="nav-contacts"><span>ğŸ‘¥</span> TG Contacts</div>
      <div class="nav-item" onclick="showPage('devices')" id="nav-devices"><span>ğŸ”’</span> Devices</div>
      <div class="nav-item" onclick="showPage('settings')" id="nav-settings"><span>âš™ï¸</span> Settings</div>
    </nav>
    <div class="content" id="content-area"></div>
  </main>
</div>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit Entry</div><button class="modal-close" onclick="closeModal('edit-modal')">Ã—</button></div>
    <div class="modal-body" id="edit-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('edit-modal')">CANCEL</button>
      <button class="btn btn-primary" onclick="saveEdit()">SAVE CHANGES</button>
    </div>
  </div>
</div>

<!-- TELEGRAM MODAL -->
<div class="modal-overlay" id="tg-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">ğŸ“¨ Send Telegram Notification</div><button class="modal-close" onclick="closeModal('tg-modal')">Ã—</button></div>
    <div class="modal-body" id="tg-modal-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('tg-modal')">CANCEL</button>
      <button class="btn btn-tg" onclick="sendTelegramNow()">SEND NOTIFICATIONS</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-overlay" id="del-modal">
  <div class="modal" style="max-width:380px">
    <div class="modal-header"><div class="modal-title" style="color:var(--danger)">Delete Entry</div><button class="modal-close" onclick="closeModal('del-modal')">Ã—</button></div>
    <div class="modal-body"><p style="color:var(--muted);font-size:13px">This action is permanent. Are you sure?</p></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('del-modal')">CANCEL</button>
      <button class="btn btn-danger" onclick="confirmDelete()" style="background:var(--danger);color:#fff">DELETE</button>
    </div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let allEntries  = [];
let tgContacts  = [];
let currentEditId   = null;
let currentDeleteId = null;
let tgEntryData     = null;
let _liveOff        = null; // unsubscribe onValue

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  const wait = setInterval(() => {
    if (window._deviceId) {
      document.getElementById('device-id-display').textContent = window._deviceId;
      clearInterval(wait);
    }
  }, 80);
  ['login-email','login-pass'].forEach(id =>
    document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); })
  );
});

window._showDeviceError = () => {
  document.getElementById('login-screen').style.display = 'none';
  const el = document.getElementById('device-error');
  el.style.display = 'flex';
  document.getElementById('blocked-device-id').textContent = window._deviceId||'unknown';
};

window._onLogin = async (user) => {
  currentUser = user;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  document.getElementById('topbar-user').textContent = user.email;
  document.getElementById('topbar-device-id').textContent = window._deviceId;
  await loadContacts();
  showPage('ledger');
};

window._onLogout = () => {
  currentUser = null;
  if (_liveOff) { _liveOff(); _liveOff = null; }
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  const btn   = document.getElementById('login-btn-text');
  errEl.textContent = ''; btn.innerHTML = '<span class="spinner"></span>';
  try {
    await window._signInFn(window._auth, email, pass);
  } catch(e) {
    errEl.textContent = 'âš  ' + ({
      'auth/invalid-email':'Invalid email.',
      'auth/user-not-found':'No account found.',
      'auth/wrong-password':'Incorrect password.',
      'auth/too-many-requests':'Too many attempts. Try later.',
      'auth/invalid-credential':'Invalid credentials.',
    }[e.code]||'Authentication failed.');
    btn.textContent = 'ACCESS SYSTEM';
  }
}
async function doLogout() { await window._signOutFn(window._auth); toast('Signed out.','info'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(page) {
  document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('nav-'+page)?.classList.add('active');
  const c = document.getElementById('content-area');
  c.innerHTML=''; c.className='content fade-in';
  ({ledger, new:newEntry, contacts, devices, settings})[page]?.(c);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE: LEDGER  â€” live onValue
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ledger(el) {
  el.innerHTML = `
    <div class="page-header">
      <div><div class="page-title">BORROW <span>LEDGER</span></div><div class="page-sub">LIVE SYNC â€” REALTIME DATABASE</div></div>
      <button class="btn btn-primary" onclick="showPage('new')">ï¼‹ NEW ENTRY</button>
    </div>
    <div class="stats-strip">
      <div class="stat-card s1"><div class="stat-label">Total Entries</div><div class="stat-value" id="st-total">â€”</div></div>
      <div class="stat-card s2"><div class="stat-label">Outstanding</div><div class="stat-value" id="st-out">â€”</div></div>
      <div class="stat-card s3"><div class="stat-label">Cash Paid</div><div class="stat-value" id="st-cash">â€”</div></div>
      <div class="stat-card s4"><div class="stat-label">Item Return</div><div class="stat-value" id="st-item">â€”</div></div>
    </div>
    <div class="toolbar">
      <input class="search-input" type="text" placeholder="Search borrower, item, courierâ€¦" oninput="filterEntries(this.value)" id="search-input">
      <select onchange="filterByStatus(this.value)">
        <option value="">All Statuses</option>
        <option value="outstanding">Outstanding</option>
        <option value="returned">Returned</option>
        <option value="paid-cash">Paid (Cash)</option>
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Date Borrowed</th><th>Borrower</th><th>Items</th><th>Payment</th><th>Courier</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="ledger-tbody"><tr><td colspan="8" style="text-align:center;padding:40px;color:var(--muted)"><span class="spinner"></span></td></tr></tbody>
      </table>
    </div>`;

  if (_liveOff) { _liveOff(); _liveOff = null; }
  _liveOff = window._onValue(window._ref(window._db,'borrow_entries'), snap => {
    const raw = snap.val()||{};
    allEntries = Object.entries(raw).map(([id,d])=>({id,...d}))
      .sort((a,b)=>(b.date_borrowed||'').localeCompare(a.date_borrowed||''));
    const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
    set('st-total',allEntries.length);
    set('st-out',  allEntries.filter(e=>e.status==='outstanding').length);
    set('st-cash', allEntries.filter(e=>e.payment_mode==='cash').length);
    set('st-item', allEntries.filter(e=>e.payment_mode==='item-return').length);
    applyFilters();
  }, err=>toast('DB error: '+err.message,'error'));
}

function renderTable(entries) {
  const tbody = document.getElementById('ledger-tbody');
  if (!tbody) return;
  if (!entries.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="es-icon">ğŸ“­</div><p>NO ENTRIES FOUND</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = entries.map((e,i)=>`
    <tr onclick="toggleDetail('${e.id}')" id="row-${e.id}">
      <td class="td-mono" style="color:var(--muted)">${String(i+1).padStart(3,'0')}</td>
      <td class="td-mono">${formatDate(e.date_borrowed)}</td>
      <td><strong>${esc(e.borrower_name)}</strong></td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(e.items)}</td>
      <td>${payBadge(e.payment_mode)}</td>
      <td>${esc(e.courier||'â€”')}</td>
      <td>${statusBadge(e.status)}</td>
      <td onclick="event.stopPropagation()" style="display:flex;gap:6px;padding:8px 14px">
        <button class="btn btn-secondary btn-sm" onclick="openEdit('${e.id}')">EDIT</button>
        <button class="btn btn-tg btn-sm" onclick="openTelegram('${e.id}')">ğŸ“¨</button>
        <button class="btn btn-danger" onclick="openDelete('${e.id}')">âœ•</button>
      </td>
    </tr>
    <tr class="detail-row" id="detail-${e.id}" style="display:none">
      <td colspan="8">
        <div class="detail-inner">
          <div class="detail-field"><div class="detail-field-label">Full Items</div><div class="detail-field-value">${esc(e.items)}</div></div>
          <div class="detail-field"><div class="detail-field-label">Date Borrowed</div><div class="detail-field-value td-mono">${formatDate(e.date_borrowed)}</div></div>
          <div class="detail-field"><div class="detail-field-label">Due Date</div><div class="detail-field-value td-mono">${formatDate(e.date_due)||'â€”'}</div></div>
          <div class="detail-field"><div class="detail-field-label">Payment</div><div class="detail-field-value">${payBadge(e.payment_mode)}</div></div>
          <div class="detail-field"><div class="detail-field-label">Courier</div><div class="detail-field-value">${esc(e.courier||'â€”')}</div></div>
          <div class="detail-field"><div class="detail-field-label">Notes</div><div class="detail-field-value" style="color:var(--muted)">${esc(e.notes||'â€”')}</div></div>
          <div class="detail-field"><div class="detail-field-label">Added By</div><div class="detail-field-value td-mono" style="font-size:10px;color:var(--muted)">${esc(e.created_by||'â€”')}</div></div>
          <div class="detail-field"><div class="detail-field-label">Entry ID</div><div class="detail-field-value td-mono" style="font-size:10px;color:var(--muted)">${e.id}</div></div>
        </div>
      </td>
    </tr>`).join('');
}

function toggleDetail(id) {
  const d = document.getElementById('detail-'+id);
  if (d) d.style.display = d.style.display==='none'?'':'none';
}

let _sf='';
function filterByStatus(s){_sf=s;applyFilters();}
function filterEntries(q){applyFilters(q);}
function applyFilters(q) {
  const search = q!==undefined?q:(document.getElementById('search-input')?.value||'');
  let f = allEntries;
  if (_sf) f = f.filter(e=>e.status===_sf||e.payment_mode===_sf);
  if (search) {
    const s = search.toLowerCase();
    f = f.filter(e=>
      (e.borrower_name||'').toLowerCase().includes(s)||
      (e.items||'').toLowerCase().includes(s)||
      (e.courier||'').toLowerCase().includes(s)||
      (e.notes||'').toLowerCase().includes(s));
  }
  renderTable(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE: NEW ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newEntry(el) {
  el.innerHTML = `
    <div class="page-header">
      <div><div class="page-title">NEW <span>ENTRY</span></div><div class="page-sub">RECORD A NEW BORROW TRANSACTION</div></div>
    </div>
    <div style="background:var(--panel);border:1px solid var(--border);padding:28px;max-width:680px">
      <div class="form-grid">
        <div class="form-group"><label>Borrower Name *</label><input type="text" id="f-borrower" placeholder="Full name"></div>
        <div class="form-group"><label>Date Borrowed *</label><input type="date" id="f-date-borrowed"></div>
        <div class="form-group full"><label>Items Borrowed *</label><textarea id="f-items" placeholder="Describe items in detailâ€¦"></textarea></div>
        <div class="form-group">
          <label>Payment Mode *</label>
          <select id="f-payment">
            <option value="">Selectâ€¦</option>
            <option value="cash">Cash</option>
            <option value="item-return">Item Return</option>
            <option value="pending">Pending</option>
          </select>
        </div>
        <div class="form-group"><label>Courier / Delivery Method</label><input type="text" id="f-courier" placeholder="e.g. LBC, J&T, Personal"></div>
        <div class="form-group">
          <label>Status</label>
          <select id="f-status">
            <option value="outstanding">Outstanding</option>
            <option value="returned">Returned</option>
            <option value="paid-cash">Paid (Cash)</option>
          </select>
        </div>
        <div class="form-group"><label>Due / Return Date</label><input type="date" id="f-date-due"></div>
        <div class="form-group full"><label>Notes</label><textarea id="f-notes" placeholder="Additional remarksâ€¦"></textarea></div>
        <div class="form-group full">
          <label>Notify via Telegram (optional)</label>
          <div class="checkbox-list" id="new-tg-list">
            ${tgContacts.length
              ? tgContacts.map(c=>`
                  <div class="checkbox-item">
                    <input type="checkbox" id="ntg-${c.id}" data-chat="${c.chat_id}">
                    <label for="ntg-${c.id}">${esc(c.name)} <span style="color:var(--muted);font-size:10px">(${c.chat_id})</span></label>
                  </div>`).join('')
              : '<span style="color:var(--muted);font-size:11px">No contacts saved. Add them in TG Contacts first.</span>'}
          </div>
        </div>
      </div>
      <div style="display:flex;gap:12px;margin-top:24px">
        <button class="btn btn-primary" onclick="saveNewEntry()">SAVE ENTRY</button>
        <button class="btn btn-secondary" onclick="showPage('ledger')">CANCEL</button>
      </div>
    </div>`;
  document.getElementById('f-date-borrowed').value = new Date().toISOString().split('T')[0];
}

async function saveNewEntry() {
  const b   = document.getElementById('f-borrower').value.trim();
  const dt  = document.getElementById('f-date-borrowed').value;
  const it  = document.getElementById('f-items').value.trim();
  const pay = document.getElementById('f-payment').value;
  if (!b||!dt||!it||!pay) { toast('Fill in all required fields.','warn'); return; }

  const data = {
    borrower_name: b, date_borrowed: dt,
    date_due:      document.getElementById('f-date-due').value||null,
    items: it, payment_mode: pay,
    courier:       document.getElementById('f-courier').value.trim()||null,
    status:        document.getElementById('f-status').value,
    notes:         document.getElementById('f-notes').value.trim()||null,
    created_at: new Date().toISOString(), created_by: currentUser.email,
  };
  try {
    const newRef = await window._push(window._ref(window._db,'borrow_entries'), data);
    toast('Entry saved!','success');
    const checked = [...document.querySelectorAll('#new-tg-list input:checked')];
    if (checked.length) {
      const msg = buildTgMsg({id:newRef.key,...data});
      for (const cb of checked) await sendTg(cb.dataset.chat, msg);
      toast(`Telegram sent to ${checked.length} contact(s).`,'success');
    }
    showPage('ledger');
  } catch(e) { toast('Error: '+e.message,'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openEdit(id) {
  const e = allEntries.find(x=>x.id===id); if(!e) return;
  currentEditId = id;
  document.getElementById('edit-modal-body').innerHTML = `
    <div class="form-grid">
      <div class="form-group"><label>Borrower Name</label><input type="text" id="e-borrower" value="${esc(e.borrower_name)}"></div>
      <div class="form-group"><label>Date Borrowed</label><input type="date" id="e-date-borrowed" value="${e.date_borrowed||''}"></div>
      <div class="form-group full"><label>Items Borrowed</label><textarea id="e-items">${esc(e.items)}</textarea></div>
      <div class="form-group">
        <label>Payment Mode</label>
        <select id="e-payment">
          <option value="cash" ${e.payment_mode==='cash'?'selected':''}>Cash</option>
          <option value="item-return" ${e.payment_mode==='item-return'?'selected':''}>Item Return</option>
          <option value="pending" ${e.payment_mode==='pending'?'selected':''}>Pending</option>
        </select>
      </div>
      <div class="form-group"><label>Courier</label><input type="text" id="e-courier" value="${esc(e.courier||'')}"></div>
      <div class="form-group">
        <label>Status</label>
        <select id="e-status">
          <option value="outstanding" ${e.status==='outstanding'?'selected':''}>Outstanding</option>
          <option value="returned" ${e.status==='returned'?'selected':''}>Returned</option>
          <option value="paid-cash" ${e.status==='paid-cash'?'selected':''}>Paid (Cash)</option>
        </select>
      </div>
      <div class="form-group"><label>Due / Return Date</label><input type="date" id="e-date-due" value="${e.date_due||''}"></div>
      <div class="form-group full"><label>Notes</label><textarea id="e-notes">${esc(e.notes||'')}</textarea></div>
    </div>`;
  openModal('edit-modal');
}

async function saveEdit() {
  if (!currentEditId) return;
  const data = {
    borrower_name: document.getElementById('e-borrower').value.trim(),
    date_borrowed: document.getElementById('e-date-borrowed').value,
    date_due:      document.getElementById('e-date-due').value||null,
    items:         document.getElementById('e-items').value.trim(),
    payment_mode:  document.getElementById('e-payment').value,
    courier:       document.getElementById('e-courier').value.trim()||null,
    status:        document.getElementById('e-status').value,
    notes:         document.getElementById('e-notes').value.trim()||null,
    updated_at: new Date().toISOString(), updated_by: currentUser.email,
  };
  try {
    await window._update(window._ref(window._db,`borrow_entries/${currentEditId}`), data);
    toast('Entry updated.','success');
    closeModal('edit-modal');
  } catch(e) { toast('Error: '+e.message,'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TELEGRAM MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openTelegram(id) {
  tgEntryData = allEntries.find(e=>e.id===id); if(!tgEntryData) return;
  const msg = buildTgMsg(tgEntryData);
  document.getElementById('tg-modal-body').innerHTML = `
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">Select recipients and send a notification about this borrow entry.</p>
    <label style="font-size:10px;letter-spacing:.12em;color:var(--muted);text-transform:uppercase">Select Recipients</label>
    <div class="tg-recipients" style="margin-top:8px" id="tg-recipient-list">
      ${tgContacts.length
        ? tgContacts.map(c=>`
            <div class="checkbox-item">
              <input type="checkbox" id="tgc-${c.id}" data-chat="${c.chat_id}" checked>
              <label for="tgc-${c.id}">${esc(c.name)}</label>
            </div>`).join('')
        : '<span style="color:var(--muted);font-size:11px">No contacts. Add them in TG Contacts.</span>'}
    </div>
    <label style="font-size:10px;letter-spacing:.12em;color:var(--muted);text-transform:uppercase;margin-top:16px;display:block">Message Preview</label>
    <div class="tg-preview" id="tg-preview">${esc(msg)}</div>
    <div style="margin-top:12px">
      <label>Custom Message (leave blank for auto-generated)</label>
      <textarea id="tg-custom" placeholder="Override messageâ€¦" style="margin-top:6px"
        oninput="document.getElementById('tg-preview').textContent=this.value||${JSON.stringify(msg).replace(/</g,'&lt;')}"></textarea>
    </div>`;
  openModal('tg-modal');
}

async function sendTelegramNow() {
  const checked = [...document.querySelectorAll('#tg-recipient-list input:checked')];
  if (!checked.length) { toast('No recipients selected.','warn'); return; }
  const custom = document.getElementById('tg-custom')?.value?.trim();
  const msg = custom||buildTgMsg(tgEntryData);
  let sent = 0;
  for (const cb of checked) { if (await sendTg(cb.dataset.chat, msg)) sent++; }
  toast(`Sent to ${sent}/${checked.length} recipient(s).`, sent>0?'success':'error');
  closeModal('tg-modal');
}

async function sendTg(chatId, text) {
  const token = window._TELEGRAM_BOT_TOKEN;
  if (!token||token==='YOUR_BOT_TOKEN') { toast('Telegram token not configured!','error'); return false; }
  try {
    const res  = await fetch(`https://api.telegram.org/bot${token}/sendMessage`,{
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({chat_id:chatId, text, parse_mode:'HTML'})
    });
    const json = await res.json();
    if (!json.ok) { console.error('TG',json); return false; }
    return true;
  } catch(e) { console.error(e); return false; }
}

function buildTgMsg(e) {
  return [
    `ğŸ“‹ <b>BORROW LEDGER NOTIFICATION</b>`,``,
    `ğŸ‘¤ <b>Borrower:</b> ${e.borrower_name}`,
    `ğŸ“… <b>Date Borrowed:</b> ${formatDate(e.date_borrowed)}`,
    `ğŸ“¦ <b>Items:</b> ${e.items}`,
    `ğŸ’³ <b>Payment:</b> ${{cash:'ğŸ’µ Cash','item-return':'ğŸ“¦ Item Return',pending:'â³ Pending'}[e.payment_mode]||e.payment_mode}`,
    `ğŸšš <b>Courier:</b> ${e.courier||'â€”'}`,
    `ğŸ“Š <b>Status:</b> ${{outstanding:'ğŸ”´ Outstanding',returned:'âœ… Returned','paid-cash':'ğŸ’° Paid (Cash)'}[e.status]||e.status}`,
    e.date_due?`ğŸ—“ <b>Due Date:</b> ${formatDate(e.date_due)}`:'',
    e.notes?`ğŸ“ <b>Notes:</b> ${e.notes}`:'',
    ``,`ğŸ†” <b>ID:</b> <code>${e.id}</code>`,
  ].filter(Boolean).join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDelete(id) { currentDeleteId=id; openModal('del-modal'); }
async function confirmDelete() {
  if (!currentDeleteId) return;
  try {
    await window._remove(window._ref(window._db,`borrow_entries/${currentDeleteId}`));
    toast('Entry deleted.','success'); closeModal('del-modal'); currentDeleteId=null;
  } catch(e) { toast('Error: '+e.message,'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE: TG CONTACTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function contacts(el) {
  el.innerHTML = `
    <div class="page-header">
      <div><div class="page-title">TELEGRAM <span>CONTACTS</span></div><div class="page-sub">NOTIFICATION RECIPIENTS</div></div>
    </div>
    <div style="display:flex;gap:28px;flex-wrap:wrap;align-items:flex-start">
      <div style="min-width:280px;background:var(--panel);border:1px solid var(--border);padding:24px">
        <div style="font-family:var(--font-head);font-weight:700;margin-bottom:18px;font-size:14px">ADD CONTACT</div>
        <div class="form-group" style="margin-bottom:12px"><label>Name</label><input type="text" id="c-name" placeholder="Display name"></div>
        <div class="form-group" style="margin-bottom:16px">
          <label>Telegram Chat ID</label>
          <input type="text" id="c-chatid" placeholder="e.g. 123456789">
          <div style="font-size:10px;color:var(--muted);margin-top:4px">Get your ID from @userinfobot on Telegram</div>
        </div>
        <button class="btn btn-primary" onclick="addContact()">ADD CONTACT</button>
      </div>
      <div style="flex:2;min-width:320px" id="contacts-list"><div class="empty-state"><span class="spinner"></span></div></div>
    </div>`;
  renderContactsList();
}

async function loadContacts() {
  try {
    const snap = await window._get(window._ref(window._db,'tg_contacts'));
    const raw  = snap.val()||{};
    tgContacts = Object.entries(raw).map(([id,d])=>({id,...d}));
  } catch(e) { console.error(e); }
}

function renderContactsList() {
  const el = document.getElementById('contacts-list'); if(!el) return;
  if (!tgContacts.length) {
    el.innerHTML=`<div class="empty-state"><div class="es-icon">ğŸ‘¥</div><p>NO CONTACTS YET</p></div>`;
    return;
  }
  el.innerHTML=`
    <table><thead><tr><th>Name</th><th>Chat ID</th><th>Actions</th></tr></thead>
    <tbody>${tgContacts.map(c=>`
      <tr>
        <td><strong>${esc(c.name)}</strong></td>
        <td class="td-mono">${esc(c.chat_id)}</td>
        <td style="display:flex;gap:8px">
          <button class="btn btn-tg btn-sm" onclick="testTg('${c.chat_id}','${esc(c.name)}')">TEST</button>
          <button class="btn btn-danger" onclick="deleteContact('${c.id}')">âœ•</button>
        </td>
      </tr>`).join('')}
    </tbody></table>`;
}

async function addContact() {
  const name  = document.getElementById('c-name')?.value?.trim();
  const cid   = document.getElementById('c-chatid')?.value?.trim();
  if (!name||!cid) { toast('Name and Chat ID required.','warn'); return; }
  try {
    const nr = await window._push(window._ref(window._db,'tg_contacts'),{
      name, chat_id:cid, added_by:currentUser.email, added_at:new Date().toISOString()
    });
    tgContacts.push({id:nr.key, name, chat_id:cid});
    renderContactsList();
    toast('Contact added.','success');
    document.getElementById('c-name').value='';
    document.getElementById('c-chatid').value='';
  } catch(e) { toast('Error: '+e.message,'error'); }
}

async function deleteContact(id) {
  try {
    await window._remove(window._ref(window._db,`tg_contacts/${id}`));
    tgContacts = tgContacts.filter(c=>c.id!==id);
    renderContactsList(); toast('Contact removed.','success');
  } catch(e) { toast('Error: '+e.message,'error'); }
}

async function testTg(chatId, name) {
  const ok = await sendTg(chatId,`âœ… <b>Borrow Ledger</b>\nTest notification for <b>${name}</b>. Connected!`);
  toast(ok?`Test sent to ${name}`:`Failed to reach ${name}`, ok?'success':'error');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE: DEVICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function devices(el) {
  el.innerHTML = `
    <div class="page-header">
      <div><div class="page-title">DEVICE <span>AUTHORIZATION</span></div><div class="page-sub">MANAGE TRUSTED DEVICES</div></div>
    </div>
    <div style="display:flex;gap:28px;flex-wrap:wrap;align-items:flex-start">
      <div style="min-width:280px;background:var(--panel);border:1px solid var(--border);padding:24px">
        <div style="font-family:var(--font-head);font-weight:700;margin-bottom:4px;font-size:14px">THIS DEVICE</div>
        <div style="font-size:10px;color:var(--accent2);margin-bottom:18px">CURRENTLY AUTHORIZED</div>
        <div style="font-family:var(--font-mono);font-size:18px;color:var(--accent);padding:12px;border:1px solid var(--border);background:var(--bg)">${window._deviceId||'unknown'}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:8px">Share this ID with admin to authorize new devices</div>
        <div style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px">
          <div style="font-family:var(--font-head);font-weight:700;margin-bottom:12px;font-size:13px">AUTHORIZE NEW DEVICE</div>
          <div class="form-group" style="margin-bottom:10px"><label>Device Label</label><input type="text" id="d-label" placeholder="e.g. Office PC"></div>
          <div class="form-group" style="margin-bottom:16px"><label>Device Fingerprint</label><input type="text" id="d-fp" placeholder="8-char hex"></div>
          <button class="btn btn-primary" onclick="addDevice()">AUTHORIZE</button>
        </div>
      </div>
      <div style="flex:2;min-width:320px" id="devices-list"><div class="empty-state"><span class="spinner"></span></div></div>
    </div>`;
  loadDevicesList();
}

async function loadDevicesList() {
  const el = document.getElementById('devices-list'); if(!el) return;
  try {
    const snap = await window._get(window._ref(window._db,'authorized_devices'));
    const raw  = snap.val()||{};
    const devs = Object.entries(raw).map(([id,d])=>({id,...d}));
    if (!devs.length) {
      el.innerHTML=`<div class="empty-state"><div class="es-icon">ğŸ”’</div><p>NO DEVICES REGISTERED</p></div>`; return;
    }
    el.innerHTML=`
      <table><thead><tr><th>Fingerprint</th><th>Label</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody>${devs.map(d=>`
        <tr>
          <td class="td-mono" style="font-size:11px">${esc(d.id)}</td>
          <td>${esc(d.label||'Unlabeled')}</td>
          <td><span class="badge ${d.active?'badge-returned':'badge-out'}">${d.active?'ACTIVE':'BLOCKED'}</span></td>
          <td style="display:flex;gap:6px">
            <button class="btn btn-secondary btn-sm" onclick="toggleDevice('${d.id}',${!d.active})">${d.active?'BLOCK':'UNBLOCK'}</button>
            <button class="btn btn-danger" onclick="removeDevice('${d.id}')">âœ•</button>
          </td>
        </tr>`).join('')}
      </tbody></table>`;
  } catch(e) { el.innerHTML=`<div style="color:var(--danger);font-size:12px">Error: ${e.message}</div>`; }
}

async function addDevice() {
  const label = document.getElementById('d-label')?.value?.trim();
  const fp    = document.getElementById('d-fp')?.value?.trim();
  if (!fp) { toast('Fingerprint ID required.','warn'); return; }
  try {
    await window._set(window._ref(window._db,`authorized_devices/${fp}`),{
      label:label||'Unlabeled', active:true,
      added_by:currentUser.email, added_at:new Date().toISOString()
    });
    toast('Device authorized.','success'); loadDevicesList();
  } catch(e) { toast('Error: '+e.message,'error'); }
}

async function toggleDevice(id, active) {
  await window._update(window._ref(window._db,`authorized_devices/${id}`),{active});
  toast(`Device ${active?'unblocked':'blocked'}.`,'success'); loadDevicesList();
}

async function removeDevice(id) {
  await window._remove(window._ref(window._db,`authorized_devices/${id}`));
  toast('Device removed.','success'); loadDevicesList();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE: SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function settings(el) {
  el.innerHTML = `
    <div class="page-header">
      <div><div class="page-title">SYSTEM <span>SETTINGS</span></div><div class="page-sub">CONFIGURATION & STATUS</div></div>
    </div>
    <div class="settings-section">
      <div class="settings-section-header">ğŸ”¥ Firebase Realtime Database</div>
      <div class="settings-body">
        <div class="settings-row"><div><div class="settings-row-label">Database Type</div><div class="settings-row-sub">Realtime Database â€” FREE tier (1 GB stored, 10 GB/month transfer)</div></div><span class="badge badge-returned">FREE</span></div>
        <div class="settings-row"><div><div class="settings-row-label">Live Sync</div><div class="settings-row-sub">Ledger updates in real-time via WebSocket / onValue()</div></div><span class="badge badge-returned">ACTIVE</span></div>
        <div class="settings-row"><div><div class="settings-row-label">Authenticated User</div></div><span style="font-family:var(--font-mono);font-size:11px;color:var(--accent)">${currentUser?.email}</span></div>
        <div class="settings-row"><div><div class="settings-row-label">Device Fingerprint</div></div><span style="font-family:var(--font-mono);font-size:11px;color:var(--accent)">${window._deviceId}</span></div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-header">ğŸ“¨ Telegram Bot</div>
      <div class="settings-body">
        <div class="settings-row"><div><div class="settings-row-label">Bot Token</div><div class="settings-row-sub">Set at top of index.html in &lt;script type="module"&gt;</div></div>
          <span class="badge ${window._TELEGRAM_BOT_TOKEN!=='YOUR_BOT_TOKEN'?'badge-returned':'badge-out'}">${window._TELEGRAM_BOT_TOKEN!=='YOUR_BOT_TOKEN'?'CONFIGURED':'NOT SET'}</span></div>
        <div class="settings-row"><div><div class="settings-row-label">Saved Contacts</div></div><span style="font-family:var(--font-head);font-size:22px;color:var(--accent)">${tgContacts.length}</span></div>
      </div>
    </div>
    <div class="settings-section">
      <div class="settings-section-header">ğŸ“‹ Quick Setup</div>
      <div class="settings-body" style="font-size:12px;line-height:2.2;color:var(--muted)">
        <div>1. Paste your Firebase config into the &lt;script type="module"&gt; block (include <code style="color:var(--accent)">databaseURL</code>).</div>
        <div>2. Enable <b>Email/Password</b> auth â†’ Firebase Console â†’ Authentication â†’ Sign-in method.</div>
        <div>3. Create a <b>Realtime Database</b> in production mode and deploy <code style="color:var(--accent)">database.rules.json</code>.</div>
        <div>4. Manually add your device: Firebase Console â†’ Realtime Database â†’ <code style="color:var(--accent)">authorized_devices / &lt;YOUR_DEVICE_ID&gt;</code> â†’ set <code style="color:var(--accent)">{active: true, label: "My PC"}</code>.</div>
        <div>5. Create Telegram bot via <b>@BotFather</b>, set token above.</div>
        <div>6. Add contacts in <b>TG Contacts</b>. Get chat IDs from <b>@userinfobot</b>.</div>
      </div>
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className=`toast ${type==='error'?'error':type==='warn'?'warn':''}`;
  el.innerHTML=`${{success:'âœ…',error:'âŒ',warn:'âš ï¸',info:'â„¹ï¸'}[type]||'â„¹ï¸'} ${msg}`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>el.remove(), 4500);
}

function esc(s) {
  if(!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatDate(d) {
  if(!d) return 'â€”';
  try {
    const dt = new Date(d+(d.includes('T')?'':'T00:00:00'));
    return dt.toLocaleDateString('en-PH',{year:'numeric',month:'short',day:'numeric'});
  } catch { return d; }
}

function payBadge(m) {
  if(m==='cash') return `<span class="badge badge-cash">ğŸ’µ Cash</span>`;
  if(m==='item-return') return `<span class="badge badge-item">ğŸ“¦ Item Return</span>`;
  return `<span class="badge badge-pending">â³ Pending</span>`;
}

function statusBadge(s) {
  if(s==='returned')  return `<span class="badge badge-returned">Returned</span>`;
  if(s==='paid-cash') return `<span class="badge badge-cash">Paid</span>`;
  return `<span class="badge badge-out">Outstanding</span>`;
}

document.querySelectorAll('.modal-overlay').forEach(o =>
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); })
);
</script>
</body>
</html>
